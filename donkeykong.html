<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donkey Kong con Carla</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: #222;
      font-family: monospace;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    canvas {
      border: 5px solid #ff0077;
      background: #000;
      display: block;
      width: 100%;
      max-width: 360px;
      height: auto;
      aspect-ratio: 4 / 5;
    }

    #controlesTactiles {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 360px;
      padding: 8px;
      box-sizing: border-box;
    }

    .botonControl {
      padding: 12px 8px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      background-color: #4CAF50;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      flex-grow: 1;
      margin: 0 4px;
    }

    .botonControl.salto {
      flex-grow: 2;
      background-color: #2196F3;
    }

    h2 {
      font-size: 18px;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <h2>Donkey Kong con Carla ü¶ç</h2>
  <canvas id="juegoCanvas" width="320" height="400"></canvas>
  <div id="controlesTactiles">
    <button class="botonControl" data-key="ArrowLeft">‚óÄÔ∏è IZQ</button>
    <button class="botonControl salto" data-key=" ">‚¨ÜÔ∏è SALTAR</button>
    <button class="botonControl" data-key="ArrowRight">DER ‚ñ∂Ô∏è</button>
  </div>
  <script>
    const canvas = document.getElementById("juegoCanvas");
    const ctx = canvas.getContext("2d");
    const ancho = canvas.width;
    const alto = canvas.height;

    let teclasPresionadas = {};
    const GRAVEDAD = 0.3;
    let juegoActivo = true;

    const ESTADO_INICIAL_CARLA = {
      ancho: 12,
      alto: 20,
      x: ancho / 2 - 6,
      y: alto - 30,
      velocidadX: 0,
      velocidadY: 0,
      velocidadMovimiento: 3,
      fuerzaSalto: -8.5,
      enElSuelo: true
    };

    let carla = { ...ESTADO_INICIAL_CARLA };
    let barriles = [];

    const donkeyKong = {
      ancho: 30,
      alto: 40,
      x: 20,
      y: 40,
      dirX: 1,
      velocidadMovimiento: 0.5,
      limiteDerecho: ancho - 50,
      limiteIzquierdo: 20,
      intervaloBarril: 2000,
      ultimoBarril: Date.now()
    };

    const meta = {
      x: ancho - 40,
      y: 35,
      ancho: 30,
      alto: 45
    };

    const plataformas = [
      { x: 0, y: alto - 10, ancho: ancho, alto: 10 },
      { x: 0, y: 80, ancho: 70, alto: 10 },
      { x: 120, y: 80, ancho: 70, alto: 10 },
      { x: 240, y: 80, ancho: ancho - 240, alto: 10 },
      { x: 50, y: alto - 100, ancho: 200, alto: 10 },
      { x: 0, y: alto - 200, ancho: 150, alto: 10 }
      // √öltima viga eliminada
    ];

    function reiniciarJuego() {
      carla = { ...ESTADO_INICIAL_CARLA };
      barriles = [];
      donkeyKong.intervaloBarril = 2000;
      donkeyKong.velocidadMovimiento = 0.5;
      juegoActivo = true;
    }

    function manejarDerrota() {
      alert("¬°Fin del Juego! Presiona OK para continuar.");
      reiniciarJuego();
    }

    function crearBarril() {
      const esRebotador = Math.random() < 0.3;
      barriles.push({
        x: donkeyKong.x + donkeyKong.ancho / 2,
        y: donkeyKong.y + donkeyKong.alto,
        radio: 6,
        velocidadX: 0,
        velocidadY: 0,
        rodando: false,
        dirRodamiento: donkeyKong.dirX,
        velocidadRodamiento: 1.5,
        rebotador: esRebotador
      });
      donkeyKong.ultimoBarril = Date.now();
    }

    function actualizarBarriles() {
      barriles = barriles.filter(b => b.y < alto + b.radio);

      barriles.forEach(b => {
        let enSuelo = false;

        if (b.rodando) {
          b.velocidadX = b.dirRodamiento * b.velocidadRodamiento;
          b.velocidadY = 0;
        } else {
          b.velocidadX = 0;
          b.velocidadY += GRAVEDAD;
        }

        plataformas.forEach(p => {
          if (b.x > p.x && b.x < p.x + p.ancho) {
            if (b.y + b.radio >= p.y && b.y + b.radio <= p.y + 5 && b.velocidadY >= 0) {
              b.y = p.y - b.radio;
              if (b.rebotador) {
                b.velocidadY = -5;
                b.rodando = false;
              } else {
                b.velocidadY = 0;
                b.rodando = true;
              }
              enSuelo = true;
            }
          }
        });

        if (b.rodando) {
          let estaSobrePlataforma = false;
          plataformas.forEach(p => {
            if (p.y === b.y + b.radio && b.x > p.x && b.x < p.x + p.ancho) {
              estaSobrePlataforma = true;
            }
          });

          if (!estaSobrePlataforma) {
            b.rodando = false;
            b.velocidadX = 0;
            b.dirRodamiento *= -1;
            b.velocidadRodamiento += 0.2;
          }
        }

        b.x += b.velocidadX;
        b.y += b.velocidadY;
      });
    }

    function comprobarColisionCarla() {
      barriles.forEach(b => {
        const dx = Math.abs((carla.x + carla.ancho / 2) - b.x);
        const dy = Math.abs((carla.y + carla.alto / 2) - b.y);
        if (dx < (carla.ancho / 2 + b.radio) && dy < (carla.alto / 2 + b.radio)) {
          manejarDerrota();
        }
      });

      if (
        carla.x < meta.x + meta.ancho && carla.x + carla.ancho > meta.x &&
        carla.y + carla.alto > meta.y && carla.y < meta.y + meta.alto
      ) {
        juegoActivo = false;
        alert("¬°Carla ha alcanzado la puerta! ¬°Has ganado!");
        reiniciarJuego();
      }
    }

    function manejarControles() {
      carla.velocidadX = 0;
      if (teclasPresionadas['ArrowLeft'] || teclasPresionadas['a']) {
        carla.velocidadX = -carla.velocidadMovimiento;
      }
      if (teclasPresionadas['ArrowRight'] || teclasPresionadas['d']) {
        carla.velocidadX = carla.velocidadMovimiento;
      }
      if (teclasPresionadas[' '] && carla.enElSuelo) {
        carla.velocidadY = carla.fuerzaSalto;
        carla.enElSuelo = false;
      }
    }

    function aplicarFisica() {
      if (!carla.enElSuelo) {
        carla.velocidadY += GRAVEDAD;
      }
      carla.x += carla.velocidadX;
      carla.y += carla.velocidadY;

      donkeyKong.x += donkeyKong.dirX * donkeyKong.velocidadMovimiento;
      if (donkeyKong.x > donkeyKong.limiteDerecho || donkeyKong.x < donkeyKong.limiteIzquierdo) {
        donkeyKong.dirX *= -1;
      }

      if (Date.now() - donkeyKong.ultimoBarril > donkeyKong.intervaloBarril) {
        crearBarril();
        donkeyKong.intervaloBarril = Math.max(500, donkeyKong.intervaloBarril - 50);
        donkeyKong.velocidadMovimiento = Math.min(2.5, donkeyKong.velocidadMovimiento + 0.05);
      }
    }

    function manejarColisiones() {
      let colisionEnSuelo = false;

      plataformas.forEach(p => {
        if (
          carla.x < p.x + p.ancho && carla.x + carla.ancho > p.x &&
          carla.y + carla.alto > p.y && carla.y < p.y + p.alto
        ) {
          if (carla.velocidadY >= 0 && carla.y + carla.alto <= p.y + 5) {
            carla.y = p.y - carla.alto;
            carla.velocidadY = 0;
            colisionEnSuelo = true;
          } else if (carla.velocidadY < 0) {
            carla.y = p.y + p.alto;
            carla.velocidadY = 0;
          }
        }
      });

      carla.enElSuelo = colisionEnSuelo;

      if (carla.x < 0) carla.x = 0;
      if (carla.x + carla.ancho > ancho) carla.x = ancho - carla.ancho;
      if (carla.y > alto) manejarDerrota();
    }
    function dibujarCarla() {
      const x = carla.x;
      const y = carla.y;
      const w = carla.ancho / 3;
      const h = carla.alto / 5;
      ctx.fillStyle = "#00BFFF";
      ctx.fillRect(x, y + h * 3, w * 3, h * 2);
      ctx.strokeStyle = "#000";
      ctx.strokeRect(x, y + h * 3, w * 3, h * 2);
      ctx.font = "24px Arial";
      ctx.fillText("üëß", carla.x - 6, carla.y + carla.alto - 2);
    }

    function dibujarDonkeyKong() {
      ctx.font = "36px Arial";
      ctx.fillText("ü¶ç", donkeyKong.x - 6, donkeyKong.y + donkeyKong.alto - 5);
    }

    function dibujarMeta() {
      ctx.fillStyle = "#FFD700";
      ctx.fillRect(meta.x, meta.y, meta.ancho, meta.alto);
      ctx.strokeStyle = "#000";
      ctx.strokeRect(meta.x, meta.y, meta.ancho, meta.alto);
      ctx.fillStyle = "#000";
      ctx.font = "12px monospace";
      ctx.fillText("META", meta.x + 4, meta.y + meta.alto / 2 + 4);
    }

    function dibujarBarriles() {
      barriles.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.radio, 0, Math.PI * 2);
        ctx.fillStyle = b.rebotador ? "#FF69B4" : "#FF8C00";
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#000";
        ctx.stroke();
        ctx.closePath();
      });
    }

    function dibujarPlataformas() {
      ctx.fillStyle = "#A9A9A9";
      plataformas.forEach(p => {
        ctx.fillRect(p.x, p.y, p.ancho, p.alto);
      });
    }

    function dibujar() {
      if (!juegoActivo) return;

      ctx.clearRect(0, 0, ancho, alto);

      dibujarPlataformas();
      dibujarMeta();
      dibujarDonkeyKong();
      dibujarBarriles();
      dibujarCarla();

      manejarControles();
      aplicarFisica();
      manejarColisiones();
      actualizarBarriles();
      comprobarColisionCarla();

      requestAnimationFrame(dibujar);
    }

    // Entradas de teclado
    document.addEventListener('keydown', (e) => {
      if ([' ', 'ArrowLeft', 'ArrowRight'].includes(e.key)) e.preventDefault();
      teclasPresionadas[e.key] = true;
    });

    document.addEventListener('keyup', (e) => {
      teclasPresionadas[e.key] = false;
    });

    // Entradas t√°ctiles
    const botones = document.querySelectorAll('.botonControl');
    botones.forEach(boton => {
      const key = boton.dataset.key;
      boton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        teclasPresionadas[key] = true;
      });
      boton.addEventListener('touchend', (e) => {
        e.preventDefault();
        teclasPresionadas[key] = false;
      });
      boton.addEventListener('mousedown', () => {
        teclasPresionadas[key] = true;
      });
      boton.addEventListener('mouseup', () => {
        teclasPresionadas[key] = false;
      });
    });

    reiniciarJuego();
    dibujar();
  </script>
</body>
</html>
