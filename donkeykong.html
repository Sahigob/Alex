<!DOCTYPE html>
<html>
<head>
    <title>Donkey Kong con Carla (Versi√≥n Final)</title>
    <style>
        body {
            margin: 0;
            background-color: #222;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            touch-action: none; 
            font-family: monospace;
            color: white;
            padding-bottom: 20px;
        }

        #contenedorJuego {
            position: relative;
        }

        canvas {
            border: 5px solid #ff0077;
            background: #000;
            display: block;
        }

        /* Estilos de botones (mantenidos) */
        #controlesTactiles {
            display: flex;
            justify-content: space-between;
            width: 320px;
            margin-top: 15px;
            padding: 0 5px;
            box-sizing: border-box;
        }

        .botonControl {
            padding: 15px 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #4CAF50;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            flex-grow: 1;
            margin: 0 5px;
            opacity: 0.9;
        }

        .botonControl.salto {
            flex-grow: 2;
            background-color: #2196F3;
        }

        .botonControl:active {
            opacity: 1.0;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        @media (min-width: 600px) {
            #controlesTactiles {
                display: none;
            }
        }
    </style>
</head>
<body>
    <h1>Donkey Kong B√°sico ü¶ç</h1>
    
    <div id="contenedorJuego">
        <canvas id="juegoCanvas" width="320" height="480"></canvas>
    </div>

    <div id="controlesTactiles">
        <button class="botonControl" data-key="ArrowLeft">‚óÄÔ∏è IZQ</button>
        <button class="botonControl salto" data-key=" ">‚¨ÜÔ∏è SALTAR</button>
        <button class="botonControl" data-key="ArrowRight">DER ‚ñ∂Ô∏è</button>
    </div>

    <script>
        const canvas = document.getElementById("juegoCanvas");
        const ctx = canvas.getContext("2d");
        const ancho = canvas.width;
        const alto = canvas.height;

        // -------------------------------------------------------------------
        // VARIABLES GLOBALES
        // -------------------------------------------------------------------
        let teclasPresionadas = {};
        const GRAVEDAD = 0.3;
        let juegoActivo = true;

        // -------------------------------------------------------------------
        // ESTADOS INICIALES (Para reinicio)
        // -------------------------------------------------------------------
        const ESTADO_INICIAL_CARLA = {
            ancho: 12,
            alto: 20,
            x: ancho / 2 - 6,
            y: alto - 30, 
            velocidadX: 0,
            velocidadY: 0,
            velocidadMovimiento: 3,
            fuerzaSalto: -8.5, 
            enElSuelo: true
        };
        
        let carla = {...ESTADO_INICIAL_CARLA}; // Carla inicial
        let barriles = []; // Array de barriles


        // 2. Donkey Kong (Lanzador)
        const donkeyKong = {
            ancho: 30,
            alto: 40,
            x: 20,
            y: 40,
            dirX: 1, 
            velocidadMovimiento: 0.5,
            limiteDerecho: ancho - 50,
            limiteIzquierdo: 20,
            intervaloBarril: 2000, 
            ultimoBarril: Date.now()
        };
        
        // 3. Puerta de Meta
        const meta = {
            x: ancho - 40,
            y: 35, 
            ancho: 30,
            alto: 45
        };

        // 4. Plataformas (CON HUECOS EN LA CIMA)
        const plataformas = [
            // El suelo (base)
            { x: 0, y: alto - 10, ancho: ancho, alto: 10 },
            
            // --- PLATAFORMA SUPERIOR CON HUECOS ---
            // Tramo 1 (Inicio)
            { x: 0, y: 80, ancho: 70, alto: 10 }, 
            // Tramo 2 (Medio)
            { x: 120, y: 80, ancho: 70, alto: 10 }, 
            // Tramo 3 (Final)
            { x: 240, y: 80, ancho: ancho - 240, alto: 10 }, 
            // ---------------------------------------
            
            // Plataforma baja 1
            { x: 50, y: alto - 100, ancho: 200, alto: 10 }, 
            // Plataforma media 2
            { x: 0, y: alto - 200, ancho: 150, alto: 10 },
            // Plataforma media 3
            { x: 170, y: alto - 300, ancho: 150, alto: 10 }
        ];


        // -------------------------------------------------------------------
        // FUNCI√ìN DE REINICIO
        // -------------------------------------------------------------------
        function reiniciarJuego() {
            // Reinicia la posici√≥n y el estado de Carla
            carla = {...ESTADO_INICIAL_CARLA}; 
            // Limpia los barriles en pantalla
            barriles = []; 
            juegoActivo = true;
        }

        function manejarDerrota() {
            // Muestra mensaje y reinicia
            alert("¬°Fin del Juego! Presiona OK para continuar.");
            reiniciarJuego();
        }


        // -------------------------------------------------------------------
        // L√ìGICA DE BARRIL
        // -------------------------------------------------------------------

        function crearBarril() {
            barriles.push({
                x: donkeyKong.x + donkeyKong.ancho / 2, 
                y: donkeyKong.y + donkeyKong.alto,
                radio: 6,
                velocidadX: 0, 
                velocidadY: 0,
                rodando: false, 
                dirRodamiento: donkeyKong.dirX,
                velocidadRodamiento: 1.5
            });
            donkeyKong.ultimoBarril = Date.now();
        }

        function actualizarBarriles() {
            barriles = barriles.filter(b => b.y < alto + b.radio);

            barriles.forEach(b => {
                let enSuelo = false;
                
                if (b.rodando) {
                    b.velocidadX = b.dirRodamiento * b.velocidadRodamiento;
                    b.velocidadY = 0;
                } else {
                    b.velocidadX = 0; 
                    b.velocidadY += GRAVEDAD;
                }

                plataformas.forEach(p => {
                    // Si el barril est√° en el rango X de la plataforma
                    if (b.x > p.x && b.x < p.x + p.ancho) {
                         // Si el barril golpea la parte superior de la plataforma
                         if (b.y + b.radio >= p.y && b.y + b.radio <= p.y + 5 && b.velocidadY >= 0) {
                            b.y = p.y - b.radio;
                            b.velocidadY = 0;
                            enSuelo = true;
                            b.rodando = true; 
                        }
                    }
                });
                
                // L√≥gica para que el barril caiga cuando llega al borde
                if (b.rodando) {
                    let estaSobrePlataforma = false;
                    plataformas.forEach(p => {
                        if (p.y === b.y + b.radio && b.x > p.x && b.x < p.x + p.ancho) {
                            estaSobrePlataforma = true;
                        }
                    });
                    
                    if (!estaSobrePlataforma) {
                         b.rodando = false;
                         b.velocidadX = 0; 
                    }
                }
                
                b.x += b.velocidadX;
                b.y += b.velocidadY;
            });
        }

        function comprobarColisionCarla() {
            // Colisi√≥n con Barriles
            barriles.forEach(b => {
                const distanciaX = Math.abs((carla.x + carla.ancho/2) - b.x);
                const distanciaY = Math.abs((carla.y + carla.alto/2) - b.y);

                if (distanciaX < (carla.ancho/2 + b.radio) && distanciaY < (carla.alto/2 + b.radio)) {
                    manejarDerrota();
                }
            });
            
            // Colisi√≥n con Meta
            if (
                carla.x < meta.x + meta.ancho && carla.x + carla.ancho > meta.x &&
                carla.y + carla.alto > meta.y && carla.y < meta.y + meta.alto 
            ) {
                juegoActivo = false;
                alert("¬°Carla ha alcanzado la puerta! ¬°Has ganado!");
                reiniciarJuego();
            }
        }

        // -------------------------------------------------------------------
        // L√ìGICA DE MOVIMIENTO PRINCIPAL Y COLISI√ìN DE CARLA
        // -------------------------------------------------------------------
        
        function manejarControles() {
            carla.velocidadX = 0; 
            
            if (teclasPresionadas['ArrowLeft'] || teclasPresionadas['a']) {
                carla.velocidadX = -carla.velocidadMovimiento;
            }
            if (teclasPresionadas['ArrowRight'] || teclasPresionadas['d']) {
                carla.velocidadX = carla.velocidadMovimiento;
            }

            if (teclasPresionadas[' '] && carla.enElSuelo) {
                carla.velocidadY = carla.fuerzaSalto;
                carla.enElSuelo = false;
            }
        }

        function aplicarFisica() {
            if (!carla.enElSuelo) {
                carla.velocidadY += GRAVEDAD;
            }
            carla.x += carla.velocidadX;
            carla.y += carla.velocidadY;

            // Movimiento y barriles de Donkey Kong
            donkeyKong.x += donkeyKong.dirX * donkeyKong.velocidadMovimiento;
            if (donkeyKong.x > donkeyKong.limiteDerecho || donkeyKong.x < donkeyKong.limiteIzquierdo) {
                donkeyKong.dirX *= -1; 
            }
            
            if (Date.now() - donkeyKong.ultimoBarril > donkeyKong.intervaloBarril) {
                crearBarril();
            }
        }

        function manejarColisiones() {
            let colisionEnSuelo = false;
            
            plataformas.forEach(p => {
                // Comprobaci√≥n de colisi√≥n (Horizontal y Vertical)
                if (
                    carla.x < p.x + p.ancho && carla.x + carla.ancho > p.x && // Rango horizontal
                    carla.y + carla.alto > p.y && carla.y < p.y + p.alto // Rango vertical
                ) {
                    // Colisi√≥n: Aterrizaje
                    if (carla.velocidadY >= 0 && carla.y + carla.alto <= p.y + 5) {
                        carla.y = p.y - carla.alto; 
                        carla.velocidadY = 0;
                        colisionEnSuelo = true;
                    } 
                    // Colisi√≥n: Golpeando por debajo
                    else if (carla.velocidadY < 0) {
                        carla.y = p.y + p.alto; 
                        carla.velocidadY = 0; 
                    }
                }
            });

            carla.enElSuelo = colisionEnSuelo;

            if (carla.x < 0) carla.x = 0;
            if (carla.x + carla.ancho > ancho) carla.x = ancho - carla.ancho;
            // Si cae por debajo del suelo (ca√≠da final)
            if (carla.y > alto) {
                 manejarDerrota();
            }
        }
        
        // -------------------------------------------------------------------
        // DIBUJO CON EMOJIS Y PIXEL ART
        // -------------------------------------------------------------------

        function dibujarCarla() {
             // Dibujar el modelo de pixel art (para mantener la referencia de colisi√≥n)
            const x = carla.x;
            const y = carla.y;
            const w = carla.ancho / 3;
            const h = carla.alto / 5;
            ctx.fillStyle = "#3498DB"; // Ropa (Azul)
            ctx.fillRect(x, y + h * 3, w * 3, h * 2);
            
            // Dibujar el EMOJI
            ctx.font = "24px Arial";
            ctx.fillText("üëß", carla.x - 6, carla.y + carla.alto - 2); 
        }

        function dibujarDonkeyKong() {
             // Solo dibujar el EMOJI (fondo eliminado)
             ctx.font = "30px Arial";
             ctx.fillText("ü¶ç", donkeyKong.x - 3, donkeyKong.y + donkeyKong.alto - 5);
        }

        function dibujarMeta() {
            ctx.fillStyle = "#FFD700"; 
            ctx.fillRect(meta.x, meta.y, meta.ancho, meta.alto);
            ctx.fillStyle = "#000";
            ctx.font = "10px monospace";
            ctx.fillText("META", meta.x + 3, meta.y + meta.alto / 2 + 3);
        }

        function dibujarBarriles() {
            barriles.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.radio, 0, Math.PI * 2);
                ctx.fillStyle = "#A0522D"; 
                ctx.fill();
                ctx.closePath();
            });
        }

        function dibujarPlataformas() {
            ctx.fillStyle = "#A9A9A9";
            plataformas.forEach(p => {
                ctx.fillRect(p.x, p.y, p.ancho, p.alto);
            });
        }

        function dibujar() {
            if (!juegoActivo) return;

            ctx.clearRect(0, 0, ancho, alto);
            
            // DIBUJAR
            dibujarPlataformas();
            dibujarMeta();
            dibujarDonkeyKong();
            dibujarBarriles();
            dibujarCarla(); 
            
            // ACTUALIZAR
            manejarControles();
            aplicarFisica();
            manejarColisiones();
            actualizarBarriles();

            // COMPROBAR
            comprobarColisionCarla();

            requestAnimationFrame(dibujar);
        }

        // -------------------------------------------------------------------
        // MANEJO DE ENTRADAS (REUTILIZADO)
        // -------------------------------------------------------------------
        document.addEventListener('keydown', (e) => {
            if ([' ', 'ArrowLeft', 'ArrowRight'].includes(e.key)) e.preventDefault();
            teclasPresionadas[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            teclasPresionadas[e.key] = false;
        });

        const botones = document.querySelectorAll('.botonControl');
        botones.forEach(boton => {
            const key = boton.dataset.key;
            
            boton.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                teclasPresionadas[key] = true;
            }, false);

            boton.addEventListener('touchend', (e) => {
                e.preventDefault(); 
                if (key === ' ') {
                    setTimeout(() => teclasPresionadas[key] = false, 50); 
                } else {
                    teclasPresionadas[key] = false;
                }
            }, false);
        });

        // Iniciar el juego
        reiniciarJuego(); // Inicializa el juego al cargar la p√°gina
        dibujar();
    </script>
</body>
</html>