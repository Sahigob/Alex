    function actualizarMisilesYColisiones() {
      misilesJugador = misilesJugador.filter(m => m.y > 0);
      misilesMarcianos = misilesMarcianos.filter(m => m.y < alto);

      for (let i = 0; i < misilesJugador.length; i++) {
        let misil = misilesJugador[i];
        misil.y += misil.velocidadY;

        for (let j = 0; j < marcianos.length; j++) {
          let marciano = marcianos[j];
          if (
            misil.x < marciano.x + marciano.ancho &&
            misil.x + misil.ancho > marciano.x &&
            misil.y < marciano.y + marciano.alto &&
            misil.y + misil.alto > marciano.y
          ) {
            const tiempoTranscurrido = (Date.now() - tiempoInicial) / 1000;
            score += Math.max(1, Math.round(50 / tiempoTranscurrido * marcianos.length));
            marcianos.splice(j, 1);
            misilesJugador.splice(i, 1);
            i--;
            if (marcianos.length === 0) {
              juegoActivo = false;
              alert("Â¡Victoria! Score Final: " + score);
              reiniciarJuego();
              return;
            }
            break;
          }
        }
      }

      for (let i = 0; i < misilesMarcianos.length; i++) {
        let laser = misilesMarcianos[i];
        laser.y += laser.velocidadY;
        if (
          laser.x < jugador.x + jugador.ancho &&
          laser.x + laser.ancho > jugador.x &&
          laser.y < jugador.y + jugador.alto &&
          laser.y + laser.alto > jugador.y
        ) {
          manejarDerrota();
          return;
        }
      }
    }

    function dibujarJugador() {
      ctx.font = `${jugador.alto}px monospace`;
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillStyle = "#0f0";
      ctx.fillText("ðŸ›¸", jugador.x, jugador.y);

      // Borde de colisiÃ³n para depuraciÃ³n
      ctx.strokeStyle = "#f0f";
      ctx.strokeRect(jugador.x, jugador.y, jugador.ancho, jugador.alto);
    }

    function dibujarMisiles() {
      ctx.fillStyle = "#ff0000";
      misilesJugador.forEach(m => {
        ctx.fillRect(m.x, m.y, m.ancho, m.alto);
      });

      ctx.fillStyle = "#FFFF00";
      misilesMarcianos.forEach(m => {
        ctx.fillRect(m.x, m.y, m.ancho, m.alto);
      });
    }

    function dibujarMarcianos() {
      ctx.font = "16px monospace";
      marcianos.forEach((m) => {
        ctx.fillStyle = "#fff";
        ctx.fillText(m.emoji, m.x, m.y + m.alto);
      });
    }

    function dibujarScore() {
      ctx.fillStyle = "#00ff00";
      ctx.font = "12px monospace";
      ctx.fillText("SCORE: " + score, 5, 15);
      const tiempoTranscurrido = ((Date.now() - tiempoInicial) / 1000).toFixed(1);
      ctx.fillText("TIME: " + tiempoTranscurrido + "s", ancho - 80, 15);
    }

    function dibujar() {
      if (!juegoActivo) return;
      ctx.clearRect(0, 0, ancho, alto);
      manejarControles();
      actualizarMarcianos();
      actualizarMisilesYColisiones();
      dibujarScore();
      dibujarJugador();
      dibujarMisiles();
      dibujarMarcianos();
      requestAnimationFrame(dibujar);
    }

    document.addEventListener('keydown', (e) => {
      if (['ArrowLeft', 'ArrowRight'].includes(e.key)) e.preventDefault();
      teclasPresionadas[e.key] = true;
    });

    document.addEventListener('keyup', (e) => {
      teclasPresionadas[e.key] = false;
    });

    const botones = document.querySelectorAll('.botonControl');
    botones.forEach(boton => {
      const key = boton.dataset.key;
      boton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        teclasPresionadas[key] = true;
        boton.classList.add('activo');
      }, false);
      boton.addEventListener('touchend', (e) => {
        e.preventDefault();
        teclasPresionadas[key] = false;
        boton.classList.remove('activo');
      }, false);
    });

    reiniciarJuego();
    dibujar();
  </script>
</body>
</html>
