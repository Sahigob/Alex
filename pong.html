<!DOCTYPE html>
<html>
<head>
    <title>Clásico Pong - Saque desde la Pala</title>
    <style>
        body {
            margin: 0;
            background-color: #222;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            touch-action: none; 
            font-family: monospace;
            color: white;
        }

        #contenedorJuego {
            position: relative;
        }

        canvas {
            border: 5px solid #00ff00; 
            background: #000;
            display: block;
        }

        /* Controles Táctiles */
        #controlesTactiles {
            display: flex;
            justify-content: center; 
            gap: 20px;
            width: 320px;
            margin-top: 15px;
            padding: 0 5px;
            box-sizing: border-box;
        }

        .botonControl {
            padding: 15px 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            flex-grow: 1;
            margin: 0 5px;
            opacity: 0.9;
        }
        
        .botonControl.movimiento {
            background-color: #3498DB; 
        }

        .botonControl:active, .botonControl.activo {
            opacity: 1.0;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        @media (min-width: 600px) {
            #controlesTactiles {
                display: none;
            }
        }
    </style>
</head>
<body>
    <h1>Pong: Saque Auténtico (A 20)</h1>
    
    <div id="contenedorJuego">
        <canvas id="juegoCanvas" width="320" height="480"></canvas>
    </div>

    <div id="controlesTactiles">
        <button class="botonControl movimiento" data-key="ArrowLeft">◀️ IZQ</button>
        <button class="botonControl movimiento" data-key="ArrowRight">DER ▶️</button>
    </div>

    <script>
        const canvas = document.getElementById("juegoCanvas");
        const ctx = canvas.getContext("2d");
        const ancho = canvas.width;
        const alto = canvas.height;

        // -------------------------------------------------------------------
        // VARIABLES GLOBALES
        // -------------------------------------------------------------------
        let juegoActivo = true;
        let teclasPresionadas = {};

        // Marcador
        let scoreJugador = 0;
        let scoreCPU = 0;
        const PUNTUACION_MAXIMA = 20;

        // Propiedad para controlar quién saca (1: Jugador, -1: CPU)
        let proximoServidor = 1; 

        // -------------------------------------------------------------------
        // ENTIDADES DEL JUEGO
        // -------------------------------------------------------------------

        const PADDLE_ANCHO = 60;
        const PADDLE_ALTO = 10;
        const PADDLE_VELOCIDAD = 5;

        // Jugador (Pala de abajo)
        const jugador = {
            x: (ancho / 2) - (PADDLE_ANCHO / 2),
            y: alto - PADDLE_ALTO - 10,
            ancho: PADDLE_ANCHO,
            alto: PADDLE_ALTO,
            velocidad: PADDLE_VELOCIDAD,
            color: "#00ff00"
        };

        // CPU (Pala de arriba)
        const cpu = {
            x: (ancho / 2) - (PADDLE_ANCHO / 2),
            y: 10,
            ancho: PADDLE_ANCHO,
            alto: PADDLE_ALTO,
            velocidad: PADDLE_VELOCIDAD * 0.8, 
            color: "#ff0000"
        };

        // Propiedades de la Bola
        const bola = {
            radio: 6,
            x: ancho / 2,
            y: alto / 2,
            velocidadX: 0, // Se inicializa en resetearBola
            velocidadY: 0, // Se inicializa en resetearBola
            color: "#ffffff"
        };
        
        // -------------------------------------------------------------------
        // LÓGICA DE REINICIO CON SAQUE DESDE LA PALA
        // -------------------------------------------------------------------

        /**
         * Reinicia la posición y velocidad de la bola para un nuevo saque.
         * @param {number} servidor - 1 para Jugador (abajo), -1 para CPU (arriba).
         */
        function resetearBola(servidor) {
            let palaServidora = (servidor === 1) ? jugador : cpu;
            
            // 1. POSICIÓN DE SAQUE: Se coloca la bola en el centro de la pala servidora
            bola.x = palaServidora.x + palaServidora.ancho / 2;
            
            if (servidor === 1) { // Jugador (abajo)
                bola.y = palaServidora.y - bola.radio; // Justo encima
            } else { // CPU (arriba)
                bola.y = palaServidora.y + palaServidora.alto + bola.radio; // Justo debajo
            }
            
            // 2. VELOCIDAD INICIAL: 
            // Dirección X: Aleatoria
            bola.velocidadX = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 2 + 2); 
            // Dirección Y: Lejos de la pala servidora
            bola.velocidadY = servidor * -4; // Si servidor es 1 (Jugador), velocidadY es -4 (sube). Si es -1 (CPU), velocidadY es 4 (baja).
            
            proximoServidor = servidor; // Guarda el servidor para el próximo punto.
        }

        function comprobarVictoria() {
            if (scoreJugador >= PUNTUACION_MAXIMA) {
                alert(`¡Ganaste! ${scoreJugador} - ${scoreCPU}. ¡Felicidades!`);
                reiniciarJuegoTotal();
                return true;
            }
            if (scoreCPU >= PUNTUACION_MAXIMA) {
                alert(`¡Perdiste! ${scoreJugador} - ${scoreCPU}. ¡La CPU ganó!`);
                reiniciarJuegoTotal();
                return true;
            }
            return false;
        }

        function reiniciarJuegoTotal() {
            scoreJugador = 0;
            scoreCPU = 0;
            // Al reiniciar, siempre saca el jugador (tú)
            resetearBola(1); 
            juegoActivo = true;
        }

        // -------------------------------------------------------------------
        // MOVIMIENTO Y LÓGICA
        // -------------------------------------------------------------------

        function moverJugador() {
            // Mueve la pala
            if (teclasPresionadas['ArrowLeft'] || teclasPresionadas['a']) {
                jugador.x -= jugador.velocidad;
            }
            if (teclasPresionadas['ArrowRight'] || teclasPresionadas['d']) {
                jugador.x += jugador.velocidad;
            }

            // Limitar al borde
            if (jugador.x < 0) jugador.x = 0;
            if (jugador.x + jugador.ancho > ancho) jugador.x = ancho - jugador.ancho;
        }

        function moverCPU() {
            // IA simple: sigue la bola
            const centroBola = bola.x;
            const centroCPU = cpu.x + cpu.ancho / 2;

            if (centroCPU < centroBola - 10) {
                cpu.x += cpu.velocidad;
            } else if (centroCPU > centroBola + 10) {
                cpu.x -= cpu.velocidad;
            }

            // Limitar al borde
            if (cpu.x < 0) cpu.x = 0;
            if (cpu.x + cpu.ancho > ancho) cpu.x = ancho - cpu.ancho;
        }

        function moverBola() {
            bola.x += bola.velocidadX;
            bola.y += bola.velocidadY;

            // Colisión con los bordes laterales (rebote)
            if (bola.x + bola.radio > ancho || bola.x - bola.radio < 0) {
                bola.velocidadX *= -1;
            }

            // Colisión con Jugador (Abajo)
            if (
                bola.y + bola.radio > jugador.y &&
                bola.x > jugador.x && bola.x < jugador.x + jugador.ancho &&
                bola.velocidadY > 0 
            ) {
                bola.velocidadY *= -1;
                const puntoImpacto = (bola.x - (jugador.x + jugador.ancho / 2)) / (jugador.ancho / 2);
                bola.velocidadX = puntoImpacto * 5; 
            }

            // Colisión con CPU (Arriba)
            if (
                bola.y - bola.radio < cpu.y + cpu.alto &&
                bola.x > cpu.x && bola.x < cpu.x + cpu.ancho &&
                bola.velocidadY < 0 
            ) {
                bola.velocidadY *= -1;
                const puntoImpacto = (bola.x - (cpu.x + cpu.ancho / 2)) / (cpu.ancho / 2);
                bola.velocidadX = puntoImpacto * 5; 
            }


            // ------------------------------------------------
            // Marcar Punto
            // ------------------------------------------------

            // Bola fuera por arriba (Punto para el Jugador)
            if (bola.y - bola.radio < 0) {
                scoreJugador++;
                if (!comprobarVictoria()) {
                   resetearBola(1); // El que ganó saca (Jugador)
                }
            }

            // Bola fuera por abajo (Punto para la CPU)
            if (bola.y + bola.radio > alto) {
                scoreCPU++;
                if (!comprobarVictoria()) {
                    resetearBola(-1); // El que ganó saca (CPU)
                }
            }
        }


        // -------------------------------------------------------------------
        // FUNCIONES DE DIBUJO
        // -------------------------------------------------------------------

        function dibujarPala(pala) {
            ctx.fillStyle = pala.color;
            ctx.fillRect(pala.x, pala.y, pala.ancho, pala.alto);
        }

        function dibujarBola() {
            ctx.beginPath();
            ctx.arc(bola.x, bola.y, bola.radio, 0, Math.PI * 2);
            ctx.fillStyle = bola.color;
            ctx.fill();
            ctx.closePath();
        }

        function dibujarMarcador() {
            ctx.fillStyle = "#ffffff";
            ctx.font = "20px monospace";
            
            // Score CPU (Arriba)
            ctx.fillText(scoreCPU, ancho - 30, 40);
            
            // Score Jugador (Abajo)
            ctx.fillText(scoreJugador, ancho - 30, alto - 20);
            
            // Indicador de saque
            ctx.fillStyle = (proximoServidor === 1) ? "#00ff00" : "#ff0000";
            ctx.beginPath();
            if (proximoServidor === 1) {
                ctx.arc(ancho - 50, alto - 25, 4, 0, Math.PI * 2); 
            } else {
                 ctx.arc(ancho - 50, 35, 4, 0, Math.PI * 2); 
            }
            ctx.fill();
            
            // Línea central
            ctx.beginPath();
            ctx.setLineDash([5, 5]); 
            ctx.moveTo(0, alto / 2);
            ctx.lineTo(ancho, alto / 2);
            ctx.strokeStyle = "#ffffff";
            ctx.stroke();
            ctx.setLineDash([]); 
        }

        // -------------------------------------------------------------------
        // BUCLE PRINCIPAL
        // -------------------------------------------------------------------

        function dibujar() {
            if (!juegoActivo) {
                 return; 
            }

            ctx.clearRect(0, 0, ancho, alto);
            
            // Actualizar lógica
            moverJugador();
            moverCPU();
            moverBola();
            
            // Dibujar
            dibujarMarcador();
            dibujarPala(jugador);
            dibujarPala(cpu);
            dibujarBola();

            requestAnimationFrame(dibujar);
        }

        // -------------------------------------------------------------------
        // MANEJO DE ENTRADAS (TÁCTIL Y TECLADO)
        // -------------------------------------------------------------------

        document.addEventListener('keydown', (e) => {
            if (['ArrowLeft', 'ArrowRight'].includes(e.key)) e.preventDefault();
            teclasPresionadas[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            teclasPresionadas[e.key] = false;
        });

        const botones = document.querySelectorAll('.botonControl');
        botones.forEach(boton => {
            const key = boton.dataset.key;

            boton.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                teclasPresionadas[key] = true;
                boton.classList.add('activo');
            }, false);

            boton.addEventListener('touchend', (e) => {
                e.preventDefault(); 
                teclasPresionadas[key] = false;
                boton.classList.remove('activo');
            }, false);
        });

        // Iniciar el juego: Tú sacas primero (1)
        resetearBola(1); 
        dibujar();
    </script>
</body>
</html>